<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Manager (Cloud Shared)</title>

    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        .input-field {
            @apply mt-1 block w-full p-3 rounded-lg shadow-xl focus:ring-indigo-500 focus:border-indigo-500;
            border: 3px solid #000000;
            width: 100%;
        }
        input[type="radio"] {
            border: 2px solid #000000;
        }
        .jobs-container:not([style*="display: none"]) + .week-group .rotate-180 {
            transform: rotate(0deg) !important;
        }
    </style>

    <script type="module">
        import PizZip from "https://esm.sh/pizzip@3.1.6";
        import Docxtemplater from "https://esm.sh/docxtemplater";
        import saveAs from "https://esm.sh/file-saver";
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserLocalPersistence
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore, doc, setDoc, onSnapshot, collection, query, deleteDoc, setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        setLogLevel('debug');

        const LABOUR_TAX_RATE = 0.20;
        const LABOUR_AFTER_TAX_MULTIPLIER = 1 - LABOUR_TAX_RATE;
        const DB_COLLECTION = 'jobs';
        const INVOICE_NUMBERS_DOC_PATH = 'invoice_config/current_numbers';

        let app, db, auth;
        let userId = null;
        let allJobs = [];
        let isAuthReady = false;
        let areInvoiceNumbersLoaded = false;

        let INVOICE_MAJOR_NUMBER = 0;
        let saltashLastMinor = 0;
        let freshbuildLastMinor = 0;

        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyAX7GYX247S69b6blLBcja-_IHU6Y9i3hI",
            authDomain: "tools-9bf35.firebaseapp.com",
            projectId: "tools-9bf35",
            storageBucket: "tools-9bf35.firebasestorage.app",
            messagingSenderId: "803649385600",
            appId: "1:803649385600:web:79fc8ed25d35ebdf032265"
        };

        const appId = FIREBASE_CONFIG.projectId;

        const CLIENT_DATA = {
            FRESHBUILD: { name: 'FRESHBUILD LIMITED', address: 'SHALIMER, CRICKET GROUND RD\nCHISLEHURST\nKENT\nBR7 5HD' },
            SALTASH: { name: 'SALTASH ENTERPRISES LIMITED', address: '110- 116 ORMSIDE STREET\nLONDON, SE15 1TF' }
        };

        function getJobsCollectionRef() { return collection(db, `artifacts/${appId}/public/data/${DB_COLLECTION}`); }
        function getInvoiceConfigDocRef() { return doc(db, `artifacts/${appId}/public/data/${INVOICE_NUMBERS_DOC_PATH}`); }

        async function initFirebase() {
            const statusDisplay = document.getElementById('authStatus');
            try {
                app = initializeApp(FIREBASE_CONFIG);
                db = getFirestore(app);
                auth = getAuth(app);
                await setPersistence(auth, browserLocalPersistence);
                await signInAnonymously(auth);
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        statusDisplay.textContent = `Status: Authenticated`;
                        if (!isAuthReady) { isAuthReady = true; setupInvoiceNumberListener(); }
                    }
                });
            } catch (error) { statusDisplay.textContent = `Error: ${error.message}`; }
        }

        function setupInvoiceNumberListener() {
            onSnapshot(getInvoiceConfigDocRef(), (docSnapshot) => {
                const data = docSnapshot.data();
                if (data) {
                    INVOICE_MAJOR_NUMBER = data.majorNumber || 25;
                    freshbuildLastMinor = data.freshbuildMinor || 0;
                    saltashLastMinor = data.saltashMinor || 0;
                }
                if (!areInvoiceNumbersLoaded) { areInvoiceNumbersLoaded = true; setupJobsListener(); }
                else { renderJobs(); }
            });
        }

        function setupJobsListener() {
            onSnapshot(query(getJobsCollectionRef()), (snapshot) => {
                allJobs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderJobs();
            });
        }

        function formatCurrency(v) { return '£' + (parseFloat(v) || 0).toFixed(2); }
        function calculateNetJobCost(job) {
            const l = parseFloat(job.labourPrice) || 0;
            const m = parseFloat(job.materialPrice) || 0;
            return { grossLabour: l, netLabour: l * LABOUR_AFTER_TAX_MULTIPLIER, material: m, totalNet: (l * LABOUR_AFTER_TAX_MULTIPLIER) + m };
        }
        function getWeekStartDate(d) {
            if (!d) return 'Unscheduled';
            const date = new Date(d + 'T00:00:00');
            const day = date.getDay();
            const diff = date.getDate() - day + (day === 0 ? -6 : 1);
            return new Date(date.setDate(diff)).toISOString().split('T')[0];
        }
        function formatWeekRange(d) {
            if (d === 'Unscheduled') return 'Unscheduled Jobs';
            const start = new Date(d + 'T00:00:00');
            const end = new Date(start); end.setDate(start.getDate() + 6);
            const f = new Intl.DateTimeFormat('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric' });
            return `Week of ${f.format(start)} – ${f.format(end)}`;
        }

        function getMajorInvoiceNumber(current) {
            const now = new Date();
            const expected = now.getMonth() < 3 ? (now.getFullYear() - 1) % 100 : now.getFullYear() % 100;
            return Math.max(current, expected);
        }

        async function saveInvoiceNumbers(major, fb, salt) {
            if (!userId) return;
            await setDoc(getInvoiceConfigDocRef(), { majorNumber: major, freshbuildMinor: fb, saltashMinor: salt }, { merge: true });
        }

        window.renderJobs = function () {
            const container = document.getElementById('jobList');
            container.innerHTML = '';
            const searchTerm = document.getElementById('jobSearch').value.toLowerCase();
            const filtered = allJobs.filter(j => (j.title + j.description).toLowerCase().includes(searchTerm));

            const grouped = filtered.reduce((acc, j) => {
                const w = getWeekStartDate(j.dateCompleted);
                if (!acc[w]) acc[w] = []; acc[w].push(j); return acc;
            }, {});

            const sortedKeys = Object.keys(grouped).sort((a, b) => new Date(a) - new Date(b));
            const currentMajor = getMajorInvoiceNumber(INVOICE_MAJOR_NUMBER);
            let tempFB = (currentMajor !== INVOICE_MAJOR_NUMBER) ? 0 : freshbuildLastMinor;
            let tempSalt = (currentMajor !== INVOICE_MAJOR_NUMBER) ? 0 : saltashLastMinor;
            const weekInvoiceMap = {};

            sortedKeys.forEach(w => {
                const pJobs = grouped[w].filter(j => j.isPeabody);
                const sJobs = grouped[w].filter(j => !j.isPeabody);
                let fb = null, salt = null;
                if (pJobs.length > 0) { tempFB++; fb = `FB_${currentMajor}.${String(tempFB).padStart(2, '0')}`; }
                if (sJobs.length > 0) { tempSalt++; salt = `${currentMajor}.${String(tempSalt).padStart(2, '0')}`; }
                weekInvoiceMap[w] = { freshbuild: fb, saltash: salt };
            });

            Object.keys(grouped).sort((a, b) => new Date(b) - new Date(a)).forEach(w => {
                const jobs = grouped[w];
                const inv = weekInvoiceMap[w];
                const fbNo = inv.freshbuild || '';
                const saltNo = inv.saltash || '';

                const groupHtml = `
                    <div class="week-group mb-6">
                        <div class="flex items-center bg-indigo-600 text-white rounded-t-xl shadow-md">
                            <button class="flex-1 p-4 text-left" onclick="toggleWeekDisplay('${w}')">
                                <span class="font-bold">${formatWeekRange(w)}</span>
                                <span class="ml-4 text-sm opacity-75">${fbNo} ${saltNo ? '| ' + saltNo : ''}</span>
                            </button>
                            <button onclick="exportWeekData('${w}', '${fbNo}', '${saltNo}')" class="bg-green-600 px-4 py-4 rounded-tr-xl font-bold">Export Week</button>
                        </div>
                        <div id="jobs-${w}" class="p-4 bg-white border rounded-b-xl space-y-4"></div>
                    </div>`;
                container.insertAdjacentHTML('beforeend', groupHtml);
                const list = document.getElementById(`jobs-${w}`);
                jobs.forEach(j => list.insertAdjacentHTML('beforeend', createJobCardHtml(j)));
                if (w !== 'Unscheduled' && !searchTerm) list.style.display = 'none';
            });
        }

        window.toggleWeekDisplay = (w) => {
            const el = document.getElementById(`jobs-${w}`);
            el.style.display = el.style.display === 'none' ? 'block' : 'none';
        }

        function createJobCardHtml(j) {
            const costs = calculateNetJobCost(j);
            return `<div class="p-4 border rounded-lg bg-gray-50">
                <div class="flex justify-between font-bold"><span>${j.title}</span><span>${formatCurrency(costs.totalNet)}</span></div>
                <p class="text-sm text-gray-600">${j.description}</p>
            </div>`;
        }

        window.addJob = async (e) => {
            e.preventDefault();
            const f = e.target;
            await setDoc(doc(getJobsCollectionRef()), {
                title: f.jobAddress.value, description: f.jobDescription.value,
                labourPrice: f.labourPrice.value, materialPrice: f.materialPrice.value,
                isPeabody: f.jobType.value === 'peabody', isHackney: f.jobType.value === 'hackney',
                dateCompleted: f.dateCompleted.value, timestamp: Date.now()
            });
            f.reset();
        }

        const generateXLSX = (jobs, type, week, invoiceNumber) => {
            const data = jobs.map(j => ({ Address: j.title, Labour: calculateNetJobCost(j).grossLabour, Materials: j.materialPrice, Description: j.description }));
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Jobs");
            // Use the passed-in invoice number for the filename
            const fileName = `${invoiceNumber.replace(/[^a-zA-Z0-9_]/g, '.')}.xlsx`;
            XLSX.writeFile(wb, fileName);
        };

        window.exportWeekData = async function (targetWeek, forcedFB, forcedSaltash) {
            const jobs = allJobs.filter(j => getWeekStartDate(j.dateCompleted) === targetWeek);
            const pJobs = jobs.filter(j => j.isPeabody);
            const sJobs = jobs.filter(j => !j.isPeabody);

            if (pJobs.length > 0 && forcedFB) {
                generateXLSX(pJobs, 'Peabody', targetWeek, forcedFB);
                const minor = parseInt(forcedFB.split('.').pop());
                if (minor > freshbuildLastMinor) freshbuildLastMinor = minor;
            }
            if (sJobs.length > 0 && forcedSaltash) {
                generateXLSX(sJobs, 'Other', targetWeek, forcedSaltash);
                const minor = parseInt(forcedSaltash.split('.').pop());
                if (minor > saltashLastMinor) saltashLastMinor = minor;
            }
            await saveInvoiceNumbers(INVOICE_MAJOR_NUMBER, freshbuildLastMinor, saltashLastMinor);
            alert("Export Complete!");
        };

        window.onload = initFirebase;
    </script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold text-indigo-700 mb-4">Job Manager</h1>
        <p id="authStatus" class="mb-6 text-sm">Initializing...</p>

        <div class="bg-white p-6 rounded-xl shadow mb-8">
            <form onsubmit="addJob(event)" class="space-y-4">
                <input type="text" id="jobAddress" name="jobAddress" placeholder="Address" required class="input-field">
                <div class="grid grid-cols-2 gap-4">
                    <input type="number" name="labourPrice" step="0.01" placeholder="Labour £" class="input-field">
                    <input type="number" name="materialPrice" step="0.01" placeholder="Materials £" class="input-field">
                </div>
                <input type="date" name="dateCompleted" class="input-field">
                <textarea name="jobDescription" placeholder="Description" class="input-field"></textarea>
                <div class="flex space-x-4">
                    <label><input type="radio" name="jobType" value="hackney"> Hackney</label>
                    <label><input type="radio" name="jobType" value="peabody"> Peabody</label>
                </div>
                <button type="submit" class="w-full bg-indigo-600 text-white p-3 rounded-lg font-bold">Add Job</button>
            </form>
        </div>

        <input type="text" id="jobSearch" oninput="renderJobs()" placeholder="Search..." class="input-field mb-6">
        <div id="jobList"></div>
    </div>
</body>
</html>
