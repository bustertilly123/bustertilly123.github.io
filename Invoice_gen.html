<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Manager (Cloud Shared)</title>

    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        .input-field {
            /* Tailwind classes for width, padding, shadow, and focus */
            @apply mt-1 block w-full p-3 rounded-lg shadow-xl focus:ring-indigo-500 focus:border-indigo-500;
            border: 3px solid #000000; /* Distinct Black Border for form elements */
            width: 100%;
        }

        input[type="radio"] {
            border: 2px solid #000000;
        }

        /* Styling to prevent rotation on details open */
        .jobs-container:not([style*="display: none"]) + .week-group .rotate-180 {
            transform: rotate(0deg) !important;
        }
    </style>

    <script type="module">
        // ===============================================
        // SECTION 0: DOCX & UTILITY IMPORTS
        // ===============================================
        import PizZip from "https://esm.sh/pizzip@3.1.6";
        import Docxtemplater from "https://esm.sh/docxtemplater";
        import saveAs from "https://esm.sh/file-saver";

        // Import necessary Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserLocalPersistence
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore, doc, setDoc, onSnapshot, collection, query, deleteDoc, setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        setLogLevel('debug');

        // ==========================================================
        // SECTION 1: CONSTANTS & GLOBAL STATE
        // ==========================================================

        const LABOUR_TAX_RATE = 0.20; // 20% reduction applied to labour price
        const LABOUR_AFTER_TAX_MULTIPLIER = 1 - LABOUR_TAX_RATE; // 0.80

        const DB_COLLECTION = 'jobs';

        let app;
        let db;
        let auth;
        let userId = null;
        let allJobs = [];
        let isAuthReady = false;

        // --- INVOICE NUMBERING CONFIGURATION ---
        // CRITICAL: You must manually update the 'saltashLastMinor' and 'freshbuildLastMinor'
        // values in this file after a successful weekly export to persist the count.
        const INVOICE_MAJOR_NUMBER = 25; // The '25' part in 25.XX or FB_25.XX
        let saltashLastMinor = 28;       // Last minor number used for Saltash (25.28). Next will be 29.
        let freshbuildLastMinor = 21;    // Last minor number used for Freshbuild (FB_25.21). Next will be 22.
        // ----------------------------------------


        // --- CONFIGURATION: User's credentials are now inserted here. ---
        //
        const FIREBASE_CONFIG = (function () {
            if (typeof __firebase_config !== 'undefined') {
                try {
                    return JSON.parse(__firebase_config);
                } catch (e) {
                    console.error("Canvas Firebase config parse error:", e);
                    return {};
                }
            }

            return {
                apiKey: "AIzaSyAX7GYX247S69b6blLBcja-_IHU6Y9i3hI",
                authDomain: "tools-9bf35.firebaseapp.com",
                projectId: "tools-9bf35",
                storageBucket: "tools-9bf35.firebasestorage.app",
                messagingSenderId: "803649385600",
                appId: "1:803649385600:web:79fc8ed25d35ebdf032265"
            };
        })();

        const appId = typeof __app_id !== 'undefined' ? __app_id : FIREBASE_CONFIG.projectId || 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- CLIENT ADDRESS DATA ---
        // *** KEYS ARE UPPERCASE ***
        const CLIENT_DATA = {
            FRESHBUILD: {
                name: 'FRESHBUILD LIMITED',
                address: 'SHALIMER, CRICKET GROUND RD\nCHISLEHURST\nKENT\nBR7 5HD'
            },
            SALTASH: {
                name: 'SALTASH ENTERPRISES LIMITED',
                address: '110- 116 ORMSIDE STREET\nLONDON, SE15 1TF'
            }
        };


        // ==========================================================
        // SECTION 2: FIREBASE INITIALIZATION & AUTH
        // ==========================================================

        function getJobsCollectionRef() {
            const collectionPath = `artifacts/${appId}/public/data/${DB_COLLECTION}`;
            return collection(db, collectionPath);
        }

        async function initFirebase() {
            const statusDisplay = document.getElementById('authStatus');
            const loadingIndicator = document.getElementById('loadingIndicator');

            if (!FIREBASE_CONFIG || !FIREBASE_CONFIG.projectId) {
                statusDisplay.textContent = 'CRITICAL ERROR: Firebase configuration missing.';
                loadingIndicator.style.display = 'none';
                return;
            }

            try {
                if (!app) {
                    app = initializeApp(FIREBASE_CONFIG);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    await setPersistence(auth, browserLocalPersistence);
                }

                statusDisplay.textContent = 'Authenticating...';
                loadingIndicator.style.display = 'block';

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        statusDisplay.textContent = `Status: Authenticated (User ID: ${userId.substring(0, 8)}...)`;

                        if (!isAuthReady) {
                            isAuthReady = true;
                            setupRealTimeListener();
                        }
                    } else {
                        statusDisplay.textContent = `Error: Authentication failed.`;
                        loadingIndicator.style.display = 'none';
                    }
                });

            } catch (error) {
                console.error("Firebase Initialization or Auth Error:", error.message, error);
                loadingIndicator.style.display = 'none';
                statusDisplay.textContent = `Error: Initialization failed (${error.code || error.message}).`;
            }
        }

        function setupRealTimeListener() {
            if (!userId) return;

            const jobsQuery = query(getJobsCollectionRef());
            const loadingIndicator = document.getElementById('loadingIndicator');

            onSnapshot(jobsQuery, (snapshot) => {
                allJobs = [];
                snapshot.forEach((doc) => {
                    allJobs.push({ id: doc.id, ...doc.data() });
                });
                loadingIndicator.style.display = 'none';
                renderJobs();
            }, (error) => {
                console.error("Error setting up real-time listener:", error);
                loadingIndicator.style.display = 'none';
                document.getElementById('authStatus').textContent = `Error loading data: ${error.message}`;
            });
        }

        // ==========================================================
        // SECTION 3: UTILITIES & CALCULATIONS
        // ==========================================================

        function formatCurrency(value) {
            const num = parseFloat(value);
            if (isNaN(num)) return '£0.00';
            return '£' + num.toFixed(2);
        }

        function calculateNetJobCost(job) {

            const rawLabour = job.labourPrice;
            const rawMaterial = job.materialPrice;

            const labour = parseFloat(rawLabour) || 0;
            const material = parseFloat(rawMaterial) || 0;

            const labourAfterTax = labour * LABOUR_AFTER_TAX_MULTIPLIER;

            return {
                grossLabour: labour,
                netLabour: labourAfterTax,
                material: material,
                totalNet: labourAfterTax + material
            };
        }

        function getWeekStartDate(dateString) {
            if (!dateString) return 'Unscheduled';

            const date = new Date(dateString + 'T00:00:00');
            const day = date.getDay();
            const diff = date.getDate() - day + (day === 0 ? -6 : 1);

            const monday = new Date(date.setDate(diff));

            return monday.toISOString().split('T')[0];
        }

        function formatWeekRange(dateString) {
            if (dateString === 'Unscheduled') return 'Unscheduled Jobs';

            const start = new Date(dateString + 'T00:00:00');
            const end = new Date(start);
            end.setDate(start.getDate() + 6);

            const formatter = new Intl.DateTimeFormat('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric' });

            return `Week of ${formatter.format(start)} – ${formatter.format(end)}`;
        }

        window.handleRadioClick = function (event) {
            const radio = event.target;
            const wasCheckedBeforeClick = radio.wasCheckedBeforeClick;
            radio.wasCheckedBeforeClick = radio.checked;

            if (wasCheckedBeforeClick) {
                radio.checked = false;
                radio.wasCheckedBeforeClick = false;
            }
        };

        // ==========================================================
        // SECTION 4: RENDERING & DISPLAY LOGIC
        // ==========================================================

        function createJobCardHtml(job) {
            const costs = calculateNetJobCost(job);
            const jobTypeDisplay = job.isHackney ? '<span class="text-blue-600 font-bold ml-2">Hackney</span>' :
                (job.isPeabody ? '<span class="text-red-600 font-bold ml-2">Peabody</span>' : 'Other');

            return `
                            <div id="job-${job.id}" class="job-card bg-gray-50 p-5 rounded-lg shadow-sm border border-gray-100">
                                <div class="flex justify-between items-start mb-3">
                                    <h3 class="text-xl font-bold text-gray-900">${job.title}</h3>
                                    <span class="text-sm font-medium text-gray-600">Completed: ${job.dateCompleted || 'N/A'}</span>
                                </div>

                                <div class="grid grid-cols-2 gap-x-4 gap-y-2 mb-3 text-sm text-gray-700 border-b pb-2">
                                    <div><span class="font-semibold text-gray-600">Labour Before Tax:</span> ${formatCurrency(costs.grossLabour)}</div>
                                    <div><span class="font-semibold text-gray-600">Labour After Tax:</span> ${formatCurrency(costs.netLabour)}</div>
                                    <div><span class="font-semibold text-gray-600">Material Cost:</span> ${formatCurrency(costs.material)}</div>
                                    <div class="col-span-2 border-t pt-2 mt-1 font-bold text-base text-indigo-700">
                                        <span class="font-semibold text-gray-600">TOTAL COST:</span> ${formatCurrency(costs.totalNet)}
                                    </div>
                                </div>

                                <div class="mb-4 text-sm font-medium pt-3">
                                    <span class="font-semibold text-gray-600">Job Type:</span> ${jobTypeDisplay}
                                </div>

                                <p class="text-gray-600 mb-4 pt-1">
                                    <span class="font-semibold text-gray-600 block mb-1">Description:</span>
                                    ${job.description || 'No detailed description provided.'}
                                </p>

                                <div class="flex justify-between items-center text-sm text-gray-500 border-t pt-3">
                                    <span>Created: ${new Date(job.timestamp).toLocaleDateString()}</span>
                                    <div class="flex items-center space-x-2">
                                        <button onclick="editJob('${job.id}')" class="text-indigo-600 hover:text-indigo-800 font-semibold transition">Edit</button>

                                        <button onclick="deleteJob('${job.id}')" class="text-red-500 hover:text-red-700 transition ml-2">
                                            <svg class="w-5 h-5 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
        }

        window.renderJobs = function () {
            const jobListContainer = document.getElementById('jobList');
            jobListContainer.innerHTML = '';

            const searchTerm = document.getElementById('jobSearch').value.toLowerCase().trim();

            const filteredJobs = searchTerm
                ? allJobs.filter(job =>
                    [job.title, job.description, formatCurrency(job.labourPrice), formatCurrency(job.materialPrice)]
                        .join(' ').toLowerCase().includes(searchTerm))
                : allJobs;

            if (filteredJobs.length === 0) {
                jobListContainer.innerHTML = `<p class="text-center text-gray-500 py-10">${searchTerm ? 'No jobs match your search criteria.' : 'No jobs found. Use the form above to add one!'}</p>`;
                return;
            }

            const groupedJobs = filteredJobs.reduce((acc, job) => {
                const weekStartDate = getWeekStartDate(job.dateCompleted);
                if (!acc[weekStartDate]) acc[weekStartDate] = [];
                acc[weekStartDate].push(job);
                return acc;
            }, {});

            const sortedGroupKeys = Object.keys(groupedJobs).sort((a, b) => {
                if (a === 'Unscheduled') return 1;
                if (b === 'Unscheduled') return -1;
                return new Date(b) - new Date(a);
            });

            sortedGroupKeys.forEach(weekStartDate => {
                const weekJobs = groupedJobs[weekStartDate].sort((a, b) => b.timestamp - a.timestamp);
                const weekTitle = formatWeekRange(weekStartDate);

                const totalWeekCost = weekJobs.reduce((sum, job) => sum + calculateNetJobCost(job).totalNet, 0);

                // --- Calculate Next Invoice Numbers for Display ---
                const peabodyJobs = weekJobs.filter(job => job.isPeabody);
                const hackneyJobs = weekJobs.filter(job => job.isHackney);

                let invoiceParts = [];

                if (peabodyJobs.length > 0) {
                    const minor = freshbuildLastMinor + 1;
                    const number = `FB_${INVOICE_MAJOR_NUMBER}.${String(minor).padStart(2, '0')}`;
                    invoiceParts.push(`Freshbuild: ${number}`);
                }

                if (hackneyJobs.length > 0) {
                    const minor = saltashLastMinor + 1;
                    const number = `${INVOICE_MAJOR_NUMBER}.${String(minor).padStart(2, '0')}`;
                    invoiceParts.push(`Saltash: ${number}`);
                }

                let invoiceDisplay = '';
                if (invoiceParts.length > 0) {
                    const displayString = invoiceParts.join(' | ');
                    // Added a separator for clarity in the header
                    invoiceDisplay = `<span class="text-base ml-4 border-l border-indigo-500 pl-4 font-medium">${displayString}</span>`;
                }
                // --- End Invoice Number Calculation ---


                const groupElement = document.createElement('div');
                groupElement.className = 'week-group mb-6';

                groupElement.innerHTML = `
                            <div class="flex items-center bg-indigo-600 text-white rounded-t-xl shadow-md">
                                <button id="toggle-${weekStartDate}"
                                        class="flex-1 flex justify-between items-center p-4 hover:bg-indigo-700 transition"
                                        onclick="toggleWeekDisplay('${weekStartDate}')" aria-expanded="true">
                                    <span class="text-xl font-semibold">${weekTitle} (${weekJobs.length} Jobs)</span>
                                    <div class="flex items-center">
                                        ${invoiceDisplay}
                                        <span class="text-xl font-bold ml-4">Total: ${formatCurrency(totalWeekCost)}</span>
                                    </div>
                                    <svg id="arrow-${weekStartDate}" class="w-6 h-6 transform transition-transform duration-300 ml-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                </button>
                                <button onclick="exportWeekData('${weekStartDate}')"
                                        class="bg-green-600 h-full px-4 py-4 rounded-tr-xl hover:bg-green-700 transition text-sm font-bold border-l border-indigo-500">
                                    Export Week
                                </button>
                            </div>
                            <div id="jobs-${weekStartDate}" class="jobs-container space-y-4 p-4 bg-white border border-t-0 border-gray-200 rounded-b-xl">
                                </div>
                        `;

                jobListContainer.appendChild(groupElement);

                const container = document.getElementById(`jobs-${weekStartDate}`);
                weekJobs.forEach(job => container.insertAdjacentHTML('beforeend', createJobCardHtml(job)));

                const shouldCollapse = (weekStartDate !== 'Unscheduled' && !searchTerm);
                if (shouldCollapse) {
                    container.style.display = 'none';
                    document.getElementById(`arrow-${weekStartDate}`).classList.add('rotate-180');
                }
            });
        }

        window.toggleWeekDisplay = function (weekStartDate) {
            const container = document.getElementById(`jobs-${weekStartDate}`);
            const arrow = document.getElementById(`arrow-${weekStartDate}`);
            const isVisible = container.style.display !== 'none';

            container.style.display = isVisible ? 'none' : 'block';
            arrow.classList.toggle('rotate-180', !isVisible);
        }

        // ==========================================================
        // SECTION 5: CRUD OPERATIONS
        // ==========================================================

        window.addJob = async function (event) {
            event.preventDefault();

            if (!isAuthReady || !userId) return;

            const form = event.target;
            const jobTypeRadios = form.elements['jobType'];
            const selectedJobType = Array.from(jobTypeRadios).find(radio => radio.checked)?.value;

            const title = form.elements['jobAddress'].value.trim();
            if (!title) return;

            const jobData = {
                title,
                address: title,
                description: form.elements['jobDescription'].value.trim(),
                labourPrice: parseFloat(form.elements['labourPrice'].value) || 0,
                materialPrice: parseFloat(form.elements['materialPrice'].value) || 0,
                isHackney: selectedJobType === 'hackney',
                isPeabody: selectedJobType === 'peabody',
                dateCompleted: form.elements['dateCompleted'].value.trim(),
                timestamp: Date.now()
            };

            try {
                await setDoc(doc(getJobsCollectionRef()), jobData);
                form.reset();
                Array.from(jobTypeRadios).forEach(radio => radio.wasCheckedBeforeClick = false);
            } catch (e) {
                console.error("Error adding document: ", e);
                document.getElementById('authStatus').textContent = `Error adding job: ${e.message}`;
            }
        }

        window.deleteJob = async function (id) {
            if (!isAuthReady || !userId) return;
            try {
                await deleteDoc(doc(getJobsCollectionRef(), id));
            } catch (e) {
                console.error("Error deleting job: ", e);
                document.getElementById('authStatus').textContent = `Error deleting job: ${e.message}`;
            }
        }

        window.editJob = function (id) {
            const job = allJobs.find(j => j.id === id);
            if (!job) return;

            const cardElement = document.getElementById(`job-${id}`);
            const checkedValue = job.isHackney ? 'hackney' : (job.isPeabody ? 'peabody' : null);

            const editFormHtml = `
                            <form id="editForm-${id}" class="space-y-4" onsubmit="saveEdit(event, '${id}')">
                                <div><label for="editAddress-${id}" class="block text-sm font-medium text-gray-700">Job Address</label><input type="text" id="editAddress-${id}" required class="input-field" value="${job.address}"></div>
                                <div class="mb-4"><label for="editDateCompleted-${id}" class="block text-sm font-medium text-gray-700">Date Completed</label><input type="date" id="editDateCompleted-${id}" class="input-field" value="${job.dateCompleted || ''}"></div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div><label for="editLabourPrice-${id}" class="block text-sm font-medium text-gray-700">Labour Price (£)</label><input type="number" id="editLabourPrice-${id}" step="0.01" placeholder="0.00" class="input-field" value="${job.labourPrice || ''}"></div>
                                    <div><label for="editMaterialPrice-${id}" class="block text-sm font-medium text-gray-700">Material Price (£)</label><input type="number" id="editMaterialPrice-${id}" step="0.01" placeholder="0.00" class="input-field" value="${job.materialPrice || ''}"></div>
                                </div>
                                <div><label for="editDescription-${id}" class="block text-sm font-medium text-gray-700">Description</label><textarea id="editDescription-${id}" rows="3" class="input-field">${job.description || ''}</textarea></div>

                                <div class="space-y-2"><span class="block text-sm font-medium text-gray-700">Job Type:</span>
                                    <div class="flex space-x-6">
                                        <div class="flex items-center">
                                            <input id="editIsHackney-${id}" type="radio" name="editJobType-${id}" value="hackney" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500" ${checkedValue === 'hackney' ? 'checked' : ''} onclick="handleRadioClick(event)">
                                            <label for="editIsHackney-${id}" class="ml-2 block text-sm font-medium text-gray-700">Hackney</label>
                                        </div>
                                        <div class="flex items-center">
                                            <input id="editIsPeabody-${id}" type="radio" name="editJobType-${id}" value="peabody" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500" ${checkedValue === 'peabody' ? 'checked' : ''} onclick="handleRadioClick(event)">
                                            <label for="editIsPeabody-${id}" class="ml-2 block text-sm font-medium text-gray-700">Peabody</label>
                                        </div>
                                    </div>
                                </div>

                                <div class="flex space-x-3 pt-2">
                                    <button type="submit" class="flex-1 bg-green-600 text-white font-bold py-2 rounded-lg shadow-md hover:bg-green-700 transition">Save Changes</button>
                                    <button type="button" onclick="renderJobs()" class="flex-1 bg-gray-300 text-gray-800 font-bold py-2 rounded-lg shadow-md hover:bg-gray-400 transition">Cancel</button>
                                </div>
                            </form>`;

            cardElement.innerHTML = editFormHtml;

            const hackneyInput = document.getElementById(`editIsHackney-${id}`);
            const peabodyInput = document.getElementById(`editIsPeabody-${id}`);
            if (hackneyInput) hackneyInput.wasCheckedBeforeClick = hackneyInput.checked;
            if (peabodyInput) peabodyInput.wasCheckedBeforeClick = peabodyInput.checked;
        }

        window.saveEdit = async function (event, id) {
            event.preventDefault();
            if (!isAuthReady || !userId) return;

            const form = document.getElementById(`editForm-${id}`);
            const selectedJobType = document.querySelector(`input[name="editJobType-${id}"]:checked`)?.value || '';

            const updatedData = {
                title: form.elements[`editAddress-${id}`].value.trim(),
                address: form.elements[`editAddress-${id}`].value.trim(),
                description: form.elements[`editDescription-${id}`].value.trim(),
                labourPrice: parseFloat(form.elements[`editLabourPrice-${id}`].value) || 0,
                materialPrice: parseFloat(form.elements[`editMaterialPrice-${id}`].value) || 0,
                isHackney: selectedJobType === 'hackney',
                isPeabody: selectedJobType === 'peabody',
                dateCompleted: form.elements[`editDateCompleted-${id}`].value.trim(),
            };

            try {
                await setDoc(doc(getJobsCollectionRef(), id), updatedData, { merge: true });
            } catch (e) {
                console.error("Error saving edit:", e);
                document.getElementById('authStatus').textContent = `Error saving job: ${e.message}`;
            }
        }

        // ==========================================================
        // SECTION 6: XLSX EXPORT LOGIC (SheetJS)
        // ==========================================================

        const generateXLSX = function (jobs, type, weekStartDate) {
            if (jobs.length === 0) return;

            const excelData = jobs.map(job => {
                const costs = calculateNetJobCost(job);

                return {
                    Address: job.title,
                    Code: "",
                    Labour: costs.grossLabour,
                    Materials: costs.material,
                    Description: job.description
                };
            });

            const headers = ["Address", "Code", "Labour", "Materials", "Description"];

            const worksheet = XLSX.utils.json_to_sheet(excelData, {
                header: headers,
                skipHeader: false
            });

            if (!worksheet['!ref']) {
                console.warn(`Worksheet reference is missing after data mapping for ${type} jobs.`);
                return;
            }

            let range = XLSX.utils.decode_range(worksheet['!ref']);
            const currencyFormat = '£#,##0.00';

            const setCellText = (ws, c, r, text) => {
                const cellRef = XLSX.utils.encode_cell({ c: c, r: r });
                ws[cellRef] = { v: text, t: 's' };
            };

            let totalLabourSum = 0;
            let totalMaterialsSum = 0;

            for (let R = range.s.r + 1; R <= range.e.r; ++R) {
                const labourCellRef = XLSX.utils.encode_cell({ c: 2, r: R });
                const labourCell = worksheet[labourCellRef];

                if (labourCell) {
                    worksheet[labourCellRef].z = currencyFormat;
                    totalLabourSum += (parseFloat(labourCell.v) || 0);
                }

                const materialCellRef = XLSX.utils.encode_cell({ c: 3, r: R });
                const materialCell = worksheet[materialCellRef];

                if (materialCell) {
                    worksheet[materialCellRef].z = currencyFormat;
                    totalMaterialsSum += (parseFloat(materialCell.v) || 0);
                }
            }


            const titleRowIndex = range.e.r + 2;
            const valueRowIndex = range.e.r + 3;

            const finalTotalSum = totalLabourSum + totalMaterialsSum;

            setCellText(worksheet, 2, titleRowIndex, 'Total Labour');
            setCellText(worksheet, 3, titleRowIndex, 'Total Materials');
            setCellText(worksheet, 4, titleRowIndex, 'Final Total');

            setCellText(worksheet, 0, valueRowIndex, 'GRAND TOTALS');

            const labourValueRef = XLSX.utils.encode_cell({ c: 2, r: valueRowIndex });
            worksheet[labourValueRef] = { t: 'n', v: totalLabourSum, z: currencyFormat };

            const materialValueRef = XLSX.utils.encode_cell({ c: 3, r: valueRowIndex });
            worksheet[materialValueRef] = { t: 'n', v: totalMaterialsSum, z: currencyFormat };

            const finalTotalValueRef = XLSX.utils.encode_cell({ c: 4, r: valueRowIndex });
            worksheet[finalTotalValueRef] = { t: 'n', v: finalTotalSum, z: currencyFormat };

            range.e.r = valueRowIndex;
            worksheet['!ref'] = XLSX.utils.encode_range(range);


            const wscols = headers.map(header => {
                let maxLen = header.length;
                const colIndex = headers.indexOf(header);

                for (let R = range.s.r + 1; R <= range.e.r; ++R) {
                    const cellRef = XLSX.utils.encode_cell({ c: colIndex, r: R });
                    const cell = worksheet[cellRef];

                    if (cell && cell.v !== null && cell.v !== undefined) {
                        let len = String(cell.v).length;

                        if (cell.z && cell.z === currencyFormat && (header === 'Labour' || header === 'Materials' || header === 'Description')) {
                            len = 10;
                        } else if (cell.t === 's' && cell.v) {
                            len = cell.v.length;
                        } else if (cell.t === 'n' && cell.w) {
                            len = cell.w.length;
                        }

                        if (len > maxLen) {
                            maxLen = len;
                        }
                    } else if (cell && cell.t === 's' && cell.v) {
                        if (cell.v.length > maxLen) {
                            maxLen = cell.v.length;
                        }
                    }
                }

                return { wch: Math.min(maxLen + 2, 50) };
            });

            worksheet['!cols'] = wscols;

            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, `${type} Report`);

            const weekTitleForFile = formatWeekRange(weekStartDate);
            const safeWeekTitle = weekTitleForFile.replace(/[^a-zA-Z0-9]/g, '_');

            XLSX.writeFile(workbook, `Job_Report_${type}_${safeWeekTitle}.xlsx`, { bookType: 'xlsx', type: 'base64' });
        };


        // ==========================================================
        // SECTION 7: DOCX GENERATION LOGIC
        // ==========================================================

        // Modified to accept the pre-calculated invoice number
        function aggregateInvoiceData(jobsToAggregate, invoiceNumber) {
            let totalLabourGross = 0;
            let totalMaterials = 0;

            const today = new Date();

            jobsToAggregate.forEach(job => {
                const costs = calculateNetJobCost(job);
                totalLabourGross += costs.grossLabour;
                totalMaterials += costs.material;
            });

            const totalLabourNet = totalLabourGross * LABOUR_AFTER_TAX_MULTIPLIER;
            const totalInvoiceAmount = totalLabourNet + totalMaterials;
            const taxAmount = totalLabourGross * LABOUR_TAX_RATE;

            return {
                INVOICE_NUMBER: invoiceNumber, // Use the calculated number
                INVOICE_DATE: today.toLocaleDateString('en-GB'),
                TOTAL: totalLabourGross.toFixed(2),
                LABOUR: totalLabourNet.toFixed(2),
                MATERIALS: totalMaterials.toFixed(2),
                TAX: taxAmount.toFixed(2),
                AFTER_TAX: totalInvoiceAmount.toFixed(2),
            };
        }

        function getClientData(clientKey) {
            // clientKey is expected to be uppercase (FRESHBUILD or SALTASH)
            const data = CLIENT_DATA[clientKey];
            if (!data) {
                throw new Error(`Client data not found for key: ${clientKey}`);
            }
            return {
                CLIENT_NAME_FULL: data.name,
                CLIENT_ADDRESS: data.address
            };
        }

        async function loadTemplateBinary(filename) {
            const response = await fetch(filename);
            if (!response.ok) {
                throw new Error(`Failed to load template: ${filename}. Status: ${response.status}`);
            }
            return response.arrayBuffer();
        }

        window.generateDocxInvoice = async function (clientKey, data) {
            // Use the correct, single template file name
            const templateFileName = `ClientInvoiceBlank.docx`;

            try {
                // Use the uppercase key to look up client data (address/name)
                const clientInfo = getClientData(clientKey.toUpperCase());

                const dataToInject = {
                    ...data,
                    ...clientInfo
                };

                // Output file name remains client-specific (e.g., Freshbuild_Invoice_...)
                const outputFileName = `${clientKey}_Invoice_${dataToInject.INVOICE_NUMBER}.docx`;

                const content = await loadTemplateBinary(templateFileName);

                const zip = new PizZip(content);
                const doc = new Docxtemplater(zip, {
                    paragraphLoop: true,
                    linebreaks: true,
                });

                doc.render(dataToInject);

                const out = doc.getZip().generate({
                    type: "blob",
                    mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
                    compression: "DEFLATE",
                });

                saveAs(out, outputFileName);

                console.log(`Successfully generated: ${outputFileName}`);
                return true;

            } catch (error) {
                console.error(`DOCX Generation Error for ${clientKey}:`, error);
                let errorMessage = `Failed to generate ${clientKey} invoice: ${error.message}`;
                if (error.message.includes("Failed to load template")) {
                    errorMessage = `CRITICAL ERROR: Failed to load the single template (${templateFileName}). Please ensure the file is uploaded and named correctly.`;
                } else if (error.properties) {
                    errorMessage = `Docxtemplater Error in template. Tag: ${error.properties.tag}, Part: ${error.properties.part}. CRITICAL: Check your Word template for hidden formatting (Content Controls) and spaces in tags.`;
                } else if (error.message.includes("Client data not found")) {
                    errorMessage = `CRITICAL ERROR: Client key mismatch. Ensure client data object keys are consistent. Error: ${error.message}`;
                }
                alert(errorMessage);
                return false;
            }
        };


        /**
         * Handles the "Export Week" button click, generating both DOCX invoices for that week
         * and then performing the XLSX export.
         */
        window.exportWeekData = async function (targetWeekStartDate) {

            const jobsToExport = allJobs.filter(job => getWeekStartDate(job.dateCompleted) === targetWeekStartDate);

            if (jobsToExport.length === 0) {
                alert(`No jobs found for the week starting ${targetWeekStartDate} to export.`);
                return;
            }

            const weekRange = formatWeekRange(targetWeekStartDate);
            let docxSuccessCount = 0;
            let xlsxExportedCount = 0;

            // Get the NEXT minor numbers for this export
            let currentFreshbuildMinor = freshbuildLastMinor + 1;
            let currentSaltashMinor = saltashLastMinor + 1;

            const peabodyJobs = jobsToExport.filter(job => job.isPeabody);
            const hackneyJobs = jobsToExport.filter(job => job.isHackney);
            const otherNonClientJobs = jobsToExport.filter(job => !job.isPeabody && !job.isHackney);

            // 2. FRESHBUILD (Peabody jobs)
            if (peabodyJobs.length > 0) {
                // Format: FB_25.22
                const freshbuildNumber = `FB_${INVOICE_MAJOR_NUMBER}.${String(currentFreshbuildMinor).padStart(2, '0')}`;
                const freshbuildData = aggregateInvoiceData(peabodyJobs, freshbuildNumber);

                if (await window.generateDocxInvoice('Freshbuild', freshbuildData)) {
                    docxSuccessCount++;
                    // Only update the global counter if generation was successful
                    freshbuildLastMinor = currentFreshbuildMinor;
                }
            } else {
                console.log('No Peabody jobs found for Freshbuild invoice.');
            }


            // 3. SALTASH (Hackney jobs)
            if (hackneyJobs.length > 0) {
                // Format: 25.29
                const saltashNumber = `${INVOICE_MAJOR_NUMBER}.${String(currentSaltashMinor).padStart(2, '0')}`;
                const saltashData = aggregateInvoiceData(hackneyJobs, saltashNumber);

                if (await window.generateDocxInvoice('Saltash', saltashData)) {
                    docxSuccessCount++;
                    // Only update the global counter if generation was successful
                    saltashLastMinor = currentSaltashMinor;
                }
            } else {
                console.log('No Hackney jobs found for Saltash invoice.');
            }


            // -----------------------------------------------------
            // --- XLSX Generation ---

            const otherJobsForXLSX = hackneyJobs.concat(otherNonClientJobs);

            if (peabodyJobs.length > 0) {
                generateXLSX(peabodyJobs, 'Peabody', targetWeekStartDate);
                xlsxExportedCount++;
            }

            if (otherJobsForXLSX.length > 0) {
                generateXLSX(otherJobsForXLSX, 'Other', targetWeekStartDate);
                xlsxExportedCount++;
            }

            // Re-render to update the numbers on the UI for subsequent exports (if any)
            renderJobs();

            // --- Final Alert ---

            let finalMessage = `Export complete for the week of ${weekRange}.\n\n`;

            if (docxSuccessCount > 0) {
                finalMessage += `DOCX Invoices Generated: ${docxSuccessCount} file(s) with new invoice numbers:\n`;
                if (peabodyJobs.length > 0) finalMessage += ` - Freshbuild: FB_${INVOICE_MAJOR_NUMBER}.${String(freshbuildLastMinor).padStart(2, '0')}\n`;
                if (hackneyJobs.length > 0) finalMessage += ` - Saltash: ${INVOICE_MAJOR_NUMBER}.${String(saltashLastMinor).padStart(2, '0')}\n`;
                finalMessage += `\n**IMPORTANT: To persist these numbers for next week, you MUST copy the final minor numbers (${freshbuildLastMinor} and ${saltashLastMinor}) back into the script's configuration constants at the top of the file.**\n`;
            } else {
                finalMessage += `DOCX Invoices: No jobs found for Freshbuild (Peabody) or Saltash (Hackney), or template error occurred.\n`;
            }

            if (xlsxExportedCount > 0) {
                finalMessage += `XLSX Reports Generated: ${xlsxExportedCount} file(s). (Totals are calculated in the code to prevent Protected View.)`;
            } else {
                finalMessage += `XLSX Reports: No jobs found for Peabody or Other report.`;
            }

            alert(finalMessage);
        };


        // ==========================================================
        // SECTION 8: INITIALIZATION
        // ==========================================================

        window.onload = function () {
            initFirebase();

            const hackneyCreate = document.getElementById('jobType-hackney');
            const peabodyCreate = document.getElementById('jobType-peabody');

            if (hackneyCreate) hackneyCreate.wasCheckedBeforeClick = hackneyCreate.checked;
            if (peabodyCreate) peabodyCreate.wasCheckedBeforeClick = peabodyCreate.checked;
        };

    </script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <h1 class="text-3xl font-extrabold text-indigo-700 mb-2">Job Manager & Invoice Generator</h1>
        <p id="authStatus" class="text-sm text-gray-600 mb-6">Status: Initializing...</p>

        <div class="bg-white p-6 rounded-xl shadow-2xl mb-8 border-t-4 border-indigo-600">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Add New Job</h2>
            <form id="addJobForm" onsubmit="addJob(event)" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="jobAddress" class="block text-sm font-medium text-gray-700">Job Address / Title</label>
                        <input type="text" id="jobAddress" name="jobAddress" required class="input-field">
                    </div>
                    <div>
                        <label for="dateCompleted" class="block text-sm font-medium text-gray-700">Date Completed</label>
                        <input type="date" id="dateCompleted" name="dateCompleted" class="input-field">
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="labourPrice" class="block text-sm font-medium text-gray-700">Labour Price (£)</label>
                        <input type="number" id="labourPrice" name="labourPrice" step="0.01" placeholder="0.00" class="input-field" value="">
                    </div>
                    <div>
                        <label for="materialPrice" class="block text-sm font-medium text-gray-700">Material Price (£)</label>
                        <input type="number" id="materialPrice" name="materialPrice" step="0.01" placeholder="0.00" class="input-field" value="">
                    </div>
                </div>

                <div>
                    <label for="jobDescription" class="block text-sm font-medium text-gray-700">Detailed Description</label>
                    <textarea id="jobDescription" name="jobDescription" rows="3" class="input-field"></textarea>
                </div>

                <div class="space-y-2">
                    <span class="block text-sm font-medium text-gray-700">Job Type (Required for invoicing):</span>
                    <div class="flex space-x-6">
                        <div class="flex items-center">
                            <input id="jobType-hackney" type="radio" name="jobType" value="hackney" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500" onclick="handleRadioClick(event)">
                            <label for="jobType-hackney" class="ml-2 block text-sm font-medium text-gray-700">Hackney (Saltash)</label>
                        </div>
                        <div class="flex items-center">
                            <input id="jobType-peabody" type="radio" name="jobType" value="peabody" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500" onclick="handleRadioClick(event)">
                            <label for="jobType-peabody" class="ml-2 block text-sm font-medium text-gray-700">Peabody (Freshbuild)</label>
                        </div>
                    </div>
                </div>

                <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg shadow-md hover:bg-indigo-700 transition duration-150 ease-in-out">Add Job</button>
            </form>
        </div>

        <h2 class="text-2xl font-semibold text-gray-800 mb-4">Completed Jobs By Week</h2>

        <div class="relative mb-6">
            <input type="text" id="jobSearch" oninput="renderJobs()" placeholder="Search by address, description, or price..." class="input-field pl-10 bg-white">
            <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
            </div>
        </div>

        <div id="loadingIndicator" class="text-center py-8" style="display:none;">
            <svg class="animate-spin h-8 w-8 text-indigo-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="text-sm text-indigo-500 mt-2">Loading job data...</p>
        </div>

        <div id="jobList" class="space-y-6">
        </div>

    </div>
</body>
</html>
