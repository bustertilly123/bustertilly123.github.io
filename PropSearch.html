<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
    <div id="market-links" class="bg-blue-50 p-6 rounded-3xl border border-blue-100 hidden">
        <h3 class="font-bold text-blue-800 mb-3">Live Market Links</h3>
        <div class="flex flex-col gap-2" id="portal-buttons">
            </div>
    </div>
    <div id="stats-box" class="bg-emerald-50 p-6 rounded-3xl border border-emerald-100 hidden">
        <h3 class="font-bold text-emerald-800 mb-2">Area Insights</h3>
        <p id="avg-price" class="text-2xl font-black text-emerald-900">£0</p>
        <p class="text-xs text-emerald-700 uppercase font-bold tracking-wider">Average Sold (Last 20)</p>
    </div>
</div>

<script>
async function searchProperty() {
    const postcode = document.getElementById('postcode').value.trim().toUpperCase();
    const tbody = document.getElementById('results-body');
    
    if (!postcode) return;

    // 1. Show the "Live Market" Links
    const portalBox = document.getElementById('market-links');
    const portalButtons = document.getElementById('portal-buttons');
    portalBox.classList.remove('hidden');
    
    // Generates direct search links for the specific postcode
    portalButtons.innerHTML = `
        <a href="https://www.rightmove.co.uk/property-for-sale/find.html?searchLocation=${postcode}" target="_blank" class="bg-white p-3 rounded-xl shadow-sm text-sm font-bold flex justify-between items-center hover:bg-slate-50 transition-all">
            Check Rightmove Listings <span class="text-blue-500">→</span>
        </a>
        <a href="https://www.zoopla.co.uk/for-sale/houses/${postcode}/" target="_blank" class="bg-white p-3 rounded-xl shadow-sm text-sm font-bold flex justify-between items-center hover:bg-slate-50 transition-all">
            Check Zoopla Listings <span class="text-blue-500">→</span>
        </a>
    `;

    // 2. Fetch the Sold History (Same as before)
    const query = `
        PREFIX lrppi: <http://landregistry.data.gov.uk/def/ppi/>
        PREFIX lrcommon: <http://landregistry.data.gov.uk/def/common/>
        SELECT ?amount ?date ?street ?paon WHERE {
            ?addr lrcommon:postcode "${postcode}" .
            ?transx lrppi:propertyAddress ?addr ;
                    lrppi:pricePaid ?amount ;
                    lrppi:transactionDate ?date .
            OPTIONAL {?addr lrcommon:street ?street}
            OPTIONAL {?addr lrcommon:paon ?paon}
        } ORDER BY DESC(?date) LIMIT 20`;

    const url = `https://landregistry.data.gov.uk/landregistry/query?query=${encodeURIComponent(query)}&output=json`;

    try {
        const response = await fetch(url);
        const data = await response.json();
        const results = data.results.bindings;

        // Calculate Average Price for the area
        if(results.length > 0) {
            const sum = results.reduce((acc, curr) => acc + parseFloat(curr.amount.value), 0);
            const avg = Math.round(sum / results.length);
            document.getElementById('stats-box').classList.remove('hidden');
            document.getElementById('avg-price').innerText = new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP', maximumFractionDigits: 0 }).format(avg);
        }

        // Render Table
        tbody.innerHTML = results.map(row => `
            <tr class="border-b hover:bg-slate-50">
                <td class="p-4 font-medium">${row.paon.value} ${row.street ? row.street.value : ''}</td>
                <td class="p-4 text-slate-500">${new Date(row.date.value).toLocaleDateString()}</td>
                <td class="p-4 text-right font-bold text-blue-600">£${parseInt(row.amount.value).toLocaleString()}</td>
            </tr>
        `).join('');

    } catch (e) {
        tbody.innerHTML = `<tr><td colspan="3" class="p-10 text-center">Error loading data.</td></tr>`;
    }
}
</script>
