<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Property Tracker Pro - Colored Pins</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />

    <style>
        body {
            margin: 0;
            font-family: 'Segoe UI', sans-serif;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        #sidebar {
            width: 360px;
            background: #fff;
            border-right: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            z-index: 1001;
        }

        .sidebar-header {
            padding: 20px;
            background: #2c3e50;
            color: white;
        }

        #property-list {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background: #fdfdfd;
        }

        .property-card {
            background: white;
            padding: 15px;
            margin-bottom: 12px;
            border-radius: 8px;
            border: 1px solid #eee;
            transition: all 0.2s;
            cursor: pointer;
            position: relative;
        }

            .property-card:hover {
                border-color: #3498db;
            }

        .status-tag {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
            text-transform: uppercase;
            color: white;
            margin-bottom: 5px;
        }

        #map {
            flex: 1;
            position: relative;
        }

        .popup-form {
            width: 220px;
        }

            .popup-form input, .popup-form select {
                width: 100%;
                padding: 8px;
                margin-bottom: 8px;
                border: 1px solid #ccc;
                border-radius: 4px;
                box-sizing: border-box;
            }

        .btn-save {
            background: #27ae60;
            color: white;
            border: none;
            padding: 10px;
            width: 100%;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }

        .btn-edit-small {
            background: none;
            border: none;
            color: #3498db;
            cursor: pointer;
            font-size: 12px;
            padding: 0;
            margin-top: 5px;
        }

        .addr-loading {
            font-size: 11px;
            color: #999;
            font-style: italic;
            display: block;
            margin-bottom: 5px;
        }
    </style>
</head>
<body>

    <div id="sidebar">
        <div class="sidebar-header">
            <h2 style="margin:0">My Properties</h2>
            <p style="margin:5px 0 0 0; font-size:12px; opacity:0.8">Click map to pin / Click card to edit</p>
        </div>
        <div id="property-list"></div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

    <script>
        const map = L.map('map').setView([52.48, -1.89], 6);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        L.Control.geocoder({ defaultMarkGeocode: true }).addTo(map);

        let pins = JSON.parse(localStorage.getItem('prop_tracker_v7')) || [];
        let editingId = null;

        // Function to get color based on status
        function getStatusColor(status) {
            switch (status) {
                case "Viewing Set": return "#f39c12"; // Orange
                case "Offer Made": return "#27ae60"; // Green
                case "Rejected": return "#e74c3c"; // Red
                default: return "#3498db"; // Blue (Shortlisted)
            }
        }

        map.on('click', function (e) {
            editingId = null;
            showForm(e.latlng.lat, e.latlng.lng);
        });

        async function showForm(lat, lng, existingData = null) {
            const popupContent = document.createElement('div');
            popupContent.className = 'popup-form';
            popupContent.innerHTML = `
                    <span id="load-msg" class="addr-loading">${existingData ? 'Editing Mode' : 'üîç Finding address...'}</span>
                    <input type="text" id="pop-addr" placeholder="Address" value="${existingData?.address || ''}">
                    <input type="text" id="pop-price" placeholder="Price" value="${existingData?.price || ''}">
                    <select id="pop-status">
                        <option value="Shortlisted" ${existingData?.status === 'Shortlisted' ? 'selected' : ''}>Shortlisted</option>
                        <option value="Viewing Set" ${existingData?.status === 'Viewing Set' ? 'selected' : ''}>Viewing Set</option>
                        <option value="Offer Made" ${existingData?.status === 'Offer Made' ? 'selected' : ''}>Offer Made</option>
                        <option value="Rejected" ${existingData?.status === 'Rejected' ? 'selected' : ''}>Rejected</option>
                    </select>
                    <input type="text" id="pop-url" placeholder="Link" value="${existingData?.url || ''}">
                    <button class="btn-save" id="save-btn">${existingData ? 'Update Property' : 'Save to List'}</button>
                `;

            const popup = L.popup().setLatLng([lat, lng]).setContent(popupContent).openOn(map);

            if (!existingData) {
                try {
                    const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}`);
                    const data = await res.json();
                    if (data.address) {
                        const street = data.address.road || "";
                        const house = data.address.house_number || "";
                        const postcode = data.address.postcode || "";
                        document.getElementById('pop-addr').value = `${house} ${street}, ${postcode}`.trim();
                        document.getElementById('load-msg').innerText = "Address found:";
                    }
                } catch (err) { document.getElementById('load-msg').innerText = "Manual address:"; }
            }

            document.getElementById('save-btn').onclick = () => saveData(lat, lng);
        }

        function saveData(lat, lng) {
            let priceVal = document.getElementById('pop-price').value.trim();
            if (priceVal && !priceVal.startsWith('¬£')) priceVal = '¬£' + priceVal;

            const data = {
                id: editingId || Date.now(),
                lat, lng,
                address: document.getElementById('pop-addr').value || "Unnamed",
                price: priceVal || "¬£-",
                status: document.getElementById('pop-status').value,
                url: document.getElementById('pop-url').value || "#"
            };

            if (editingId) {
                const index = pins.findIndex(p => p.id === editingId);
                pins[index] = data;
            } else {
                pins.push(data);
            }

            localStorage.setItem('prop_tracker_v7', JSON.stringify(pins));
            map.closePopup();
            render();
        }

        window.editProperty = function (id) {
            const p = pins.find(pin => pin.id === id);
            editingId = id;
            map.setView([p.lat, p.lng], 17);
            showForm(p.lat, p.lng, p);
        };

        window.deletePin = function (e, id) {
            e.stopPropagation();
            if (confirm("Delete this property?")) {
                pins = pins.filter(p => p.id !== id);
                localStorage.setItem('prop_tracker_v7', JSON.stringify(pins));
                render();
            }
        };

        function render() {
            // Clear all markers
            map.eachLayer(l => { if (l instanceof L.CircleMarker) map.removeLayer(l); });
            const list = document.getElementById('property-list');
            list.innerHTML = '';

            pins.forEach((p) => {
                const color = getStatusColor(p.status);

                // Add CIRCLE MARKER instead of default pin
                L.circleMarker([p.lat, p.lng], {
                    radius: 10,
                    fillColor: color,
                    color: "#fff",
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.9
                }).addTo(map)
                    .bindPopup(`<b>${p.address}</b><br>${p.price}<br><button class="btn-edit-small" onclick="editProperty(${p.id})">Edit Details</button>`);

                const card = document.createElement('div');
                card.className = 'property-card';
                card.onclick = () => editProperty(p.id);
                card.innerHTML = `
                        <span class="status-tag" style="background:${color}">${p.status}</span>
                        <button onclick="deletePin(event, ${p.id})" style="float:right; background:none; border:none; color:#ccc; cursor:pointer; font-size:20px;">&times;</button>
                        <h4>${p.address}</h4>
                        <p style="font-weight:bold; color:#2c3e50; margin:0">${p.price}</p>
                    `;
                list.appendChild(card);
            });
        }

        render();
    </script>
</body>
</html>